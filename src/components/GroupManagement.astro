---
import { mockGroups, mockTeamMembers } from '../lib/mockData'
import { getAllGroupsWithMembers, groupsStore, teamMembersStore } from '../stores/groupStore'
import GroupDeleteModal from './GroupDeleteModal.astro'
import GroupForm from './GroupForm.astro'
import GroupList from './GroupList.astro'
import LoadingSpinner from './LoadingSpinner.astro'

// モックデータで初期化（実際の実装ではAPI経由でデータ取得）
// Note: このコードはサーバーサイドで実行されるため、ページリロード時に毎回実行される
// 実際のアプリケーションでは、データの永続化（localStorage、データベースなど）が必要
//
// 現在の実装の制限事項：
// 1. グループを作成してもページリロードでリセットされる
// 2. 編集・削除も同様に永続化されない
// 3. 本番環境では以下の対応が必要：
//    - APIサーバーとの連携
//    - データベースへの保存
//    - または最低限localStorageでの一時保存
if (teamMembersStore.get().length === 0) {
  teamMembersStore.set(mockTeamMembers)
}
// グループデータの初期化も同様
if (groupsStore.get().length === 0) {
  groupsStore.set(mockGroups)
}

const groups = getAllGroupsWithMembers()
const teamMembers = teamMembersStore.get()
---

<div class="group-management">
  <div class="header">
    <h1>グループ管理</h1>
    <button id="create-group-btn" class="btn btn-primary ripple-container button-hover focus-glow">
      <span class="btn-badge">新</span>
      新しいグループを作成
    </button>
  </div>

  <!-- エラーメッセージ表示エリア -->
  <div id="error-container"></div>

  <!-- ローディングスピナー -->
  <div id="loading-overlay" class="hidden">
    <LoadingSpinner isLoading={true} fullScreen={true} message="処理中..." />
  </div>

  <!-- グループ一覧 -->
  <div id="group-list-container" class="animate-fade-in">
    <GroupList groups={groups} />
  </div>

  <!-- グループ作成フォーム -->
  <div id="create-form-container" class="form-container hidden animate-fade-in">
    <GroupForm 
      teamMembers={teamMembers}
      mode="create"
      existingGroups={groups.map(g => ({ id: g.id, name: g.name, memberIds: g.memberIds }))}
    />
  </div>

  <!-- グループ編集フォーム -->
  <div id="edit-form-container" class="form-container hidden animate-fade-in">
    <div class="group-form">
      <h3>グループを編集</h3>
      <form id="edit-form" novalidate>
        <div class="form-group">
          <label for="edit-name">グループ名</label>
          <input
            type="text"
            id="edit-name"
            name="name"
            placeholder="グループ名を入力"
            required
          />
          <div class="error-message hidden" id="edit-name-error">
            このグループ名は既に使用されています
          </div>
        </div>

        <div class="form-group">
          <label>メンバーを選択</label>
          <div class="members-selection" id="edit-members-selection">
            <!-- メンバーチェックボックスは動的に生成 -->
          </div>
          <div class="error-message hidden" id="edit-members-error">
            少なくとも1人のメンバーを選択してください
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary ripple-container button-hover focus-glow">
            更新
          </button>
          <button type="button" class="btn btn-secondary ripple-container button-hover focus-glow" data-action="cancel">
            キャンセル
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 削除確認モーダル -->
  <GroupDeleteModal />
</div>

<script>
  console.log('GroupManagement script initialized');
  
  // グローバル変数として初期化を示すフラグ
  (window as any).groupManagementInitialized = true;
  
  let currentMode: string | null = null;
  let currentGroupId: string | null = null;
  
  // イベントリスナーを管理するための配列
  const eventHandlers: Array<{ element: EventTarget, event: string, handler: EventListener }> = [];
  
  // 同期的な初期データの設定
  let dataAdapter: any = null;
  
  // ストア関数の実装
  const groupsStore = {
    get: () => {
      return dataAdapter?.getGroups() || [];
    }
  };
  
  const teamMembersStore = {
    get: () => {
      return dataAdapter?.getTeamMembers() || [];
    }
  };
  
  const getAllGroupsWithMembers = () => groupsStore.get();
  
  const createGroup = (name: string, memberIds: string[]) => {
    return dataAdapter?.createGroup(name, memberIds);
  };
  
  const updateGroup = (id: string, data: { name: string, memberIds: string[] }) => {
    dataAdapter?.updateGroup(id, data);
  };
  
  const deleteGroup = (id: string) => {
    dataAdapter?.deleteGroup(id);
  };
  
  const clearError = () => {
    // エラークリア処理は簡略化
  };
  
  // クリーンアップ関数
  function cleanup() {
    eventHandlers.forEach(({ element, event, handler }) => {
      element.removeEventListener(event, handler);
    });
    eventHandlers.length = 0;
  }
  
  // ページ離脱時のクリーンアップ
  window.addEventListener('beforeunload', cleanup);
  
  // 非同期でデータアダプターを初期化
  (async () => {
    try {
      const module = await import('../lib/e2eDataAdapter');
      dataAdapter = module.dataAdapter;
    } catch (error) {
      console.error('Failed to load data adapter:', error);
    }
  })();
    
    // ローディング状態とエラー状態の簡易実装
    const isLoadingStore = {
      subscribe: (callback: (loading: boolean) => void) => {
        // 簡易実装のため、常にfalseを返す
        callback(false);
      }
    };
    
    const errorStore = {
      subscribe: (callback: (error: string | null) => void) => {
        // 簡易実装のため、常にnullを返す
        callback(null);
      }
    };
    
    // DOM要素
    const createGroupBtn = document.getElementById('create-group-btn');
    const createFormContainer = document.getElementById('create-form-container');
    const editFormContainer = document.getElementById('edit-form-container');
    const listContainer = document.getElementById('group-list-container');
    const errorContainer = document.getElementById('error-container');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // フォーム表示/非表示関数を先に定義
    function showCreateForm() {
      createFormContainer?.classList.remove('hidden');
      editFormContainer?.classList.add('hidden');
      listContainer?.classList.add('fade');
    }
    
    function showEditForm() {
      editFormContainer?.classList.remove('hidden');
      createFormContainer?.classList.add('hidden');
      listContainer?.classList.add('fade');
    }
    
    function hideForms() {
      createFormContainer?.classList.add('hidden');
      editFormContainer?.classList.add('hidden');
      listContainer?.classList.remove('fade');
    }
    
    // 編集フォームにデータを設定
    function setupEditForm(group: any) {
      const nameInput = document.getElementById('edit-name') as HTMLInputElement;
      if (nameInput) {
        nameInput.value = group.name;
      }
      
      // メンバー選択を更新
      const membersContainer = document.getElementById('edit-members-selection');
      if (membersContainer) {
        const teamMembers = teamMembersStore.get();
        membersContainer.innerHTML = teamMembers.map((member: any) => `
          <label class="member-checkbox">
            <input
              type="checkbox"
              name="memberIds"
              value="${member.id}"
              ${group.memberIds.includes(member.id) ? 'checked' : ''}
            />
            <span class="member-info">
              <span class="member-name">${member.name}</span>
              <span class="member-email">${member.email}</span>
            </span>
          </label>
        `).join('');
      }
    }
    
    // イベントリスナーを即座に登録
    console.log('GroupManagement: Registering event listeners');
    
    // DOMContentLoadedまたは即座に実行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupEventListeners);
    } else {
      setupEventListeners();
    }
    
    function setupEventListeners() {
      console.log('GroupManagement: Setting up event listeners');
      
      // ローディング状態の購読
      isLoadingStore.subscribe(isLoading => {
        if (loadingOverlay) {
          if (isLoading) {
            loadingOverlay.classList.remove('hidden');
          } else {
            loadingOverlay.classList.add('hidden');
          }
        }
      });
      
      // エラー状態の購読
      errorStore.subscribe(error => {
        if (errorContainer) {
          if (error) {
            // エラーメッセージを動的に追加
            const errorElement = document.createElement('div');
            errorElement.innerHTML = `
              <div class="error-message" role="alert">
                <span class="error-badge">!</span>
                <span class="error-text">${error}</span>
                <button type="button" class="close-btn" aria-label="エラーを閉じる">
                  <span class="close-badge">×</span>
                </button>
              </div>
            `;
            
            const errorMessage = errorElement.firstElementChild as HTMLElement;
            const closeBtn = errorMessage?.querySelector('.close-btn');
            
            if (closeBtn) {
              closeBtn.addEventListener('click', () => {
                clearError();
                if (errorMessage) {
                  errorMessage.remove();
                }
              });
            }
            
            // 5秒後に自動的にエラーメッセージを非表示にする
            setTimeout(() => {
              if (errorMessage) {
                errorMessage.classList.add('fade-out');
                setTimeout(() => {
                  clearError();
                  if (errorMessage) {
                    errorMessage.remove();
                  }
                }, 300);
              }
            }, 5000);
            
            if (errorMessage) {
              errorContainer.appendChild(errorMessage);
            }
          }
        }
      });
      
      // グループ作成ボタン
      createGroupBtn?.addEventListener('click', () => {
        currentMode = 'create';
        currentGroupId = null;
        showCreateForm();
      });
      
      // 編集ボタンのイベント
      const editHandler = (e: Event) => {
        const customEvent = e as CustomEvent;
        console.log('GroupManagement: group-edit event received', customEvent.detail);
        const groupId = customEvent.detail.groupId;
        if (groupId) {
          currentMode = 'edit';
          currentGroupId = groupId;
          
          // 編集対象のグループを取得
          const allGroups = getAllGroupsWithMembers();
          const group = allGroups.find((g: any) => g.id === groupId);
          if (group) {
            setupEditForm(group);
            showEditForm();
          }
        }
      };
      window.addEventListener('group-edit', editHandler);
      eventHandlers.push({ element: window, event: 'group-edit', handler: editHandler });
      
      // 削除ボタンのイベント
      const deleteHandler = (e: Event) => {
        const customEvent = e as CustomEvent;
        console.log('GroupManagement: group-delete event received', customEvent.detail);
        const groupId = customEvent.detail.groupId;
        if (groupId) {
          currentGroupId = groupId;
          // モーダルを表示
          const modal = document.querySelector('.modal-overlay');
          if (modal) {
            modal.classList.add('open');
            // グループ名を設定
            const group = groupsStore.get().find((g: any) => g.id === groupId);
            if (group) {
              const modalGroupName = modal.querySelector('.modal-body strong');
              if (modalGroupName) {
                modalGroupName.textContent = group.name;
              }
            }
          }
        }
      };
      window.addEventListener('group-delete', deleteHandler);
      eventHandlers.push({ element: window, event: 'group-delete', handler: deleteHandler });
      
      // 作成フォームイベント
      const formSubmitHandler = (e: Event) => {
        console.log('group-form-submit event received:', e);
        const customEvent = e as CustomEvent;
        const { name, memberIds } = customEvent.detail;
        console.log('Event detail:', customEvent.detail);
        
        if (currentMode === 'create') {
          console.log('Creating group:', name, memberIds);
          const newGroup = createGroup(name, memberIds);
          console.log('New group created:', newGroup);
          
          if (newGroup) {
            hideForms();
            window.location.reload();
          } else {
            console.error('Failed to create group');
          }
        }
      };
      window.addEventListener('group-form-submit', formSubmitHandler);
      eventHandlers.push({ element: window, event: 'group-form-submit', handler: formSubmitHandler });
      
      const formCancelHandler = () => {
        hideForms();
      };
      window.addEventListener('group-form-cancel', formCancelHandler);
      eventHandlers.push({ element: window, event: 'group-form-cancel', handler: formCancelHandler });
      
      // 削除モーダルイベント
      const deleteConfirmHandler = () => {
        if (currentGroupId) {
          deleteGroup(currentGroupId);
          // モーダルを閉じる
          const modal = document.querySelector('.modal-overlay');
          modal?.classList.remove('open');
          // ページをリロードして更新を反映
          window.location.reload();
        }
      };
      window.addEventListener('group-delete-confirm', deleteConfirmHandler);
      eventHandlers.push({ element: window, event: 'group-delete-confirm', handler: deleteConfirmHandler });
      
      const deleteCancelHandler = () => {
        // モーダルを閉じる
        const modal = document.querySelector('.modal-overlay');
        modal?.classList.remove('open');
        currentGroupId = null;
      };
      window.addEventListener('group-delete-cancel', deleteCancelHandler);
      eventHandlers.push({ element: window, event: 'group-delete-cancel', handler: deleteCancelHandler });
    }
    
    // 編集フォームのイベントリスナー
    const editForm = document.getElementById('edit-form') as HTMLFormElement;
    if (editForm) {
      const nameInput = document.getElementById('edit-name') as HTMLInputElement;
      const nameError = document.getElementById('edit-name-error');
      const membersError = document.getElementById('edit-members-error');
      
      // グループ名の重複チェック関数
      function checkDuplicateName(name: string) {
        const trimmedName = name.trim();
        if (!trimmedName) return false;
        
        const allGroups = groupsStore.get();
        return allGroups.some((g: any) => {
          // 編集中のグループ自身は除外
          if (g.id === currentGroupId) return false;
          return g.name.toLowerCase() === trimmedName.toLowerCase();
        });
      }
      
      // グループ名の入力時にリアルタイムでチェック
      if (nameInput) {
        nameInput.addEventListener('input', (e) => {
          const target = e.target as HTMLInputElement;
          const isDuplicate = checkDuplicateName(target.value);
          if (isDuplicate && nameError) {
            nameError.classList.remove('hidden');
            nameInput.classList.add('error');
          } else if (nameError) {
            nameError.classList.add('hidden');
            nameInput.classList.remove('error');
          }
        });
      }
      
      editForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(editForm);
        const name = formData.get('name') as string;
        const memberIds = formData.getAll('memberIds') as string[];
        
        let hasError = false;
        
        // グループ名のバリデーション
        const trimmedName = name?.trim();
        if (!trimmedName) {
          hasError = true;
        } else if (checkDuplicateName(trimmedName) && nameError) {
          nameError.classList.remove('hidden');
          if (nameInput) nameInput.classList.add('error');
          hasError = true;
        } else if (nameError) {
          nameError.classList.add('hidden');
          if (nameInput) nameInput.classList.remove('error');
        }
        
        // メンバー数のバリデーション
        if (memberIds.length === 0 && membersError) {
          membersError.classList.remove('hidden');
          hasError = true;
        } else if (membersError) {
          membersError.classList.add('hidden');
        }
        
        // エラーがなければ送信
        if (!hasError && currentGroupId && trimmedName) {
          updateGroup(currentGroupId, { name: trimmedName, memberIds });
          hideForms();
          window.location.reload();
        }
      });
      
      const cancelButton = editForm.querySelector('[data-action="cancel"]');
      if (cancelButton) {
        cancelButton.addEventListener('click', () => {
          hideForms();
        });
      }
    }
</script>

<style>
  .group-management {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-8);
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-8);
    flex-wrap: wrap;
    gap: var(--spacing-4);
  }

  h1 {
    margin: 0;
    font-size: var(--font-size-3xl);
    color: var(--color-text-primary);
    font-weight: var(--font-weight-bold);
    letter-spacing: var(--letter-spacing-tight);
  }

  .btn {
    padding: var(--spacing-3) var(--spacing-6);
    font-size: var(--font-size-base);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--duration-fast) var(--easing-spring);
    font-weight: var(--font-weight-medium);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    min-height: 44px;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity var(--duration-fast) var(--easing-in-out);
  }

  .btn:hover {
    transform: translateY(-1px);
  }

  .btn:hover::before {
    opacity: 1;
  }

  .btn:active {
    transform: translateY(0) scale(0.98);
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--color-primary-500), var(--color-primary-600));
    color: white;
    box-shadow: var(--shadow-md);
  }

  .btn-primary::before {
    background: linear-gradient(135deg, var(--color-primary-600), var(--color-primary-700));
  }

  .btn-primary:hover {
    box-shadow: var(--shadow-lg);
  }

  .btn-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: white;
    color: var(--color-primary-500);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-bold);
  }

  .form-container {
    margin-bottom: var(--spacing-8);
  }

  .hidden {
    display: none;
  }

  .fade {
    opacity: 0.5;
    pointer-events: none;
  }

  /* グループフォームのスタイル */
  .group-form {
    background-color: var(--color-surface);
    padding: var(--spacing-8);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
    max-width: 500px;
    box-shadow: var(--shadow-lg);
  }

  .group-form h3 {
    margin: 0 0 var(--spacing-8) 0;
    font-size: var(--font-size-2xl);
    color: var(--color-text-primary);
    font-weight: var(--font-weight-semibold);
    letter-spacing: var(--letter-spacing-tight);
  }

  .form-group {
    margin-bottom: var(--spacing-6);
  }

  .form-group label {
    display: block;
    margin-bottom: var(--spacing-3);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  .form-group input[type="text"] {
    width: 100%;
    padding: var(--spacing-4);
    font-size: var(--font-size-base);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: all var(--duration-fast) var(--easing-in-out);
    background-color: var(--color-background);
    color: var(--color-text-primary);
  }

  .form-group input[type="text"]:focus {
    outline: none;
    border-color: var(--color-primary-500);
    background-color: var(--color-surface);
  }

  .members-selection {
    max-height: 320px;
    overflow-y: auto;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-3);
    background-color: var(--color-background);
    scrollbar-width: thin;
    scrollbar-color: var(--color-gray-400) transparent;
  }

  .members-selection::-webkit-scrollbar {
    width: 8px;
  }

  .members-selection::-webkit-scrollbar-track {
    background: transparent;
  }

  .members-selection::-webkit-scrollbar-thumb {
    background-color: var(--color-gray-400);
    border-radius: var(--radius-full);
  }

  .member-checkbox {
    display: flex;
    align-items: center;
    padding: var(--spacing-3);
    margin: var(--spacing-1) 0;
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all var(--duration-fast) var(--easing-in-out);
    min-height: 44px;
  }

  .member-checkbox:hover {
    background-color: var(--color-surface-hover);
    transform: translateX(2px);
  }

  .member-checkbox input[type="checkbox"] {
    margin-right: var(--spacing-3);
    cursor: pointer;
    width: 18px;
    height: 18px;
    accent-color: var(--color-primary-500);
  }

  .member-info {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    gap: var(--spacing-1);
  }

  .member-name {
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    font-size: var(--font-size-base);
  }

  .member-email {
    font-size: var(--font-size-sm);
    color: var(--color-text-tertiary);
  }

  .form-actions {
    display: flex;
    gap: var(--spacing-4);
    justify-content: flex-end;
    margin-top: var(--spacing-8);
    padding-top: var(--spacing-6);
    border-top: 1px solid var(--color-border);
  }

  .btn-secondary {
    background: linear-gradient(135deg, var(--color-gray-100), var(--color-gray-200));
    color: var(--color-text-primary);
    box-shadow: var(--shadow-sm);
  }

  .btn-secondary::before {
    background: linear-gradient(135deg, var(--color-gray-200), var(--color-gray-300));
  }

  .btn-secondary:hover {
    box-shadow: var(--shadow-md);
  }

  /* バリデーションエラーのスタイル */
  .error-message {
    color: var(--color-error);
    font-size: var(--font-size-sm);
    margin-top: var(--spacing-2);
    padding: var(--spacing-2) var(--spacing-3);
    background-color: rgba(239, 68, 68, 0.05);
    border-radius: var(--radius-sm);
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  input.error {
    border-color: var(--color-error);
    background-color: rgba(239, 68, 68, 0.02);
  }

  input.error:focus {
    border-color: var(--color-error);
  }

  /* エラーメッセージのスタイル（動的に追加される要素用） */
  :global(.error-message[role="alert"]) {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-4);
    background-color: rgba(239, 68, 68, 0.05);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: var(--radius-md);
    color: var(--color-error);
    margin-bottom: var(--spacing-4);
    animation: slideIn var(--duration-fast) var(--easing-in-out);
    box-shadow: var(--shadow-sm);
  }
  
  :global(.error-badge) {
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--color-error);
    color: white;
    border-radius: var(--radius-full);
    font-weight: var(--font-weight-bold);
    font-size: var(--font-size-base);
  }
  
  :global(.close-badge) {
    font-size: var(--font-size-xl);
    line-height: 1;
    font-weight: var(--font-weight-normal);
  }
  
  :global(.error-text) {
    flex-grow: 1;
    font-weight: var(--font-weight-medium);
  }
  
  :global(.error-message .close-btn) {
    flex-shrink: 0;
    background: none;
    border: none;
    color: var(--color-error);
    cursor: pointer;
    padding: var(--spacing-2);
    border-radius: var(--radius-md);
    transition: all var(--duration-fast) var(--easing-in-out);
    min-width: 32px;
    min-height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  :global(.error-message .close-btn:hover) {
    background-color: rgba(239, 68, 68, 0.1);
  }
  
  :global(.fade-out) {
    animation: fadeOut var(--duration-normal) var(--easing-in-out) forwards;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  #error-container {
    position: relative;
    z-index: 100;
  }

  #loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: var(--z-index-modal);
  }

  #loading-overlay.hidden {
    display: none;
  }

  /* レスポンシブ対応 */
  @media (max-width: 768px) {
    .group-management {
      padding: var(--spacing-4);
    }

    .header {
      margin-bottom: var(--spacing-6);
    }

    h1 {
      font-size: var(--font-size-2xl);
      flex: 1 1 100%;
    }

    .btn {
      padding: var(--spacing-3) var(--spacing-5);
      min-height: 48px;
      flex: 1 1 auto;
      justify-content: center;
    }

    .btn-primary {
      width: 100%;
    }

    .form-container {
      margin-bottom: var(--spacing-6);
    }

    .group-form {
      padding: var(--spacing-6);
      max-width: 100%;
      border-radius: var(--radius-lg);
    }

    .group-form h3 {
      font-size: var(--font-size-xl);
      margin-bottom: var(--spacing-6);
    }

    .form-group {
      margin-bottom: var(--spacing-5);
    }

    .form-group label {
      font-size: var(--font-size-base);
    }

    .form-group input[type="text"] {
      min-height: 48px;
    }

    .members-selection {
      max-height: 280px;
      padding: var(--spacing-2);
    }

    .member-checkbox {
      padding: var(--spacing-3) var(--spacing-2);
      min-height: 48px;
    }

    .member-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }

    .form-actions {
      margin-top: var(--spacing-6);
      padding-top: var(--spacing-4);
      gap: var(--spacing-3);
      flex-wrap: wrap;
    }

    .form-actions .btn {
      flex: 1 1 calc(50% - var(--spacing-2));
      min-width: 120px;
    }
  }

  @media (max-width: 480px) {
    .group-management {
      padding: var(--spacing-3);
    }

    h1 {
      font-size: var(--font-size-xl);
    }

    .group-form {
      padding: var(--spacing-4);
      border-radius: 0;
      border-left: none;
      border-right: none;
      box-shadow: none;
    }

    .members-selection {
      max-height: 240px;
    }

    .form-actions {
      gap: var(--spacing-2);
    }

    .form-actions .btn {
      flex: 1 1 100%;
    }

    .btn-primary {
      order: -1;
    }
  }

  /* タッチデバイスでのホバー効果の調整 */
  @media (hover: none) and (pointer: coarse) {
    .member-checkbox:hover {
      background-color: transparent;
      transform: none;
    }

    .btn:hover {
      transform: none;
    }

    .member-checkbox:active {
      background-color: var(--color-surface-active);
    }

    .btn:active {
      transform: scale(0.98);
    }
  }

  /* アクセシビリティ: モーション設定 */
  @media (prefers-reduced-motion: reduce) {
    .member-checkbox,
    .btn {
      transition: none;
    }

    @keyframes slideIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  }

  /* ダークモード対応 */
  @media (prefers-color-scheme: dark) {
    .btn-badge {
      background: var(--color-primary-800);
      color: white;
    }
  }
</style> 